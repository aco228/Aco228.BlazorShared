@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject IJSRuntime JS

<AInputBase Title="@Title" Subtitle="@Subtitle" Disabled="@Disabled" IsLoading="@IsLoading" Width="@Width">
    <div class="a-fileinput">

        <InputFile id="@_inputId" OnChange="HandleInputChange" multiple="@Multiple" accept="@Accept" style="display:none" />

        <div class="a-fileinput-dropzone @(_isDragging ? "a-fileinput-dropzone--dragging" : "") @(Disabled || IsLoading ? "a-fileinput-dropzone--disabled" : "")"
             @ref="_dropzoneEl">
            <div class="a-fileinput-dropzone-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="36" height="36" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5v-9m0 0-3.75 3.75M12 7.5l3.75 3.75M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75z" />
                </svg>
            </div>
            <p class="a-fileinput-dropzone-text">
                Drop files here or paste, or
                <button class="a-fileinput-browse"
                        type="button"
                        disabled="@(Disabled || IsLoading)"
                        @onclick="TriggerBrowse">browse</button>
            </p>
            @if (!string.IsNullOrEmpty(Accept))
            {
                <span class="a-fileinput-dropzone-hint">Accepted: @Accept</span>
            }
        </div>

        @if (_files.Count > 0)
        {
            <ul class="a-fileinput-list">
                @foreach (var file in _files)
                {
                    var f = file;
                    <li class="a-fileinput-item" @key="@($"{f.Name}-{f.Size}-{f.LastModified.Ticks}")">
                        <div class="a-fileinput-item-icon" aria-hidden="true">
                            <svg viewBox="0 0 16 16" fill="currentColor" width="14" height="14">
                                <path d="M4 0h5.293A1 1 0 0 1 10 .293L13.707 4a1 1 0 0 1 .293.707V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2zm5.5 1.5v2a1 1 0 0 0 1 1h2L9.5 1.5z" />
                            </svg>
                        </div>
                        <div class="a-fileinput-item-info">
                            <span class="a-fileinput-item-name" title="@f.Name">@f.Name</span>
                            <span class="a-fileinput-item-meta">
                                @FormatFileSize(f.Size)@(string.IsNullOrEmpty(f.ContentType) ? "" : $" Â· {f.ContentType}")
                            </span>
                        </div>
                        <button class="a-fileinput-item-remove"
                                type="button"
                                title="Remove file"
                                disabled="@(Disabled || IsLoading)"
                                @onclick="() => RemoveFile(f)">
                            <svg viewBox="0 0 16 16" fill="currentColor" width="12" height="12" aria-hidden="true">
                                <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
                            </svg>
                        </button>
                    </li>
                }
            </ul>

            <div class="a-fileinput-actions">
                <button class="a-fileinput-clear"
                        type="button"
                        disabled="@(Disabled || IsLoading)"
                        @onclick="ClearAll">
                    Clear all
                </button>
                <button class="a-fileinput-upload"
                        type="button"
                        disabled="@(Disabled || IsLoading)"
                        @onclick="TriggerUpload">
                    <svg viewBox="0 0 16 16" fill="currentColor" width="13" height="13" aria-hidden="true">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 1 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z" />
                    </svg>
                    Upload @(_files.Count == 1 ? "1 file" : $"{_files.Count} files")
                </button>
            </div>
        }

    </div>
</AInputBase>

@code {
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? Subtitle { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public int Width { get; set; }

    /// <summary>Allow staging multiple files at once. Default: true.</summary>
    [Parameter] public bool Multiple { get; set; } = true;

    /// <summary>Accepted MIME types or extensions (e.g. "image/*,.pdf"). Empty = all.</summary>
    [Parameter] public string Accept { get; set; } = "image/*";

    /// <summary>Fired whenever the staged file list changes (add / remove).</summary>
    [Parameter] public EventCallback<IReadOnlyList<IBrowserFile>> OnChange { get; set; }

    /// <summary>Fired when the user clicks the Upload button. Contains all currently staged files.</summary>
    [Parameter] public EventCallback<IReadOnlyList<IBrowserFile>> OnUpload { get; set; }

    private string _inputId = string.Empty;
    private ElementReference _dropzoneEl;
    private IJSObjectReference? _module;
    private DotNetObjectReference<AFileInput>? _dotnetRef;
    private readonly List<IBrowserFile> _files = new();
    private bool _isDragging;

    protected override void OnInitialized()
    {
        _inputId = $"a-fileinput-{Guid.NewGuid():N}";
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        _module = await JS.InvokeAsync<IJSObjectReference>(
            "import", "./_content/Aco228.BlazorShared/Components/Inputs/AFileInput.razor.js");
        _dotnetRef = DotNetObjectReference.Create(this);
        await _module.InvokeVoidAsync("initialize", _dropzoneEl, _inputId, _dotnetRef);
    }

    private async Task HandleInputChange(InputFileChangeEventArgs e)
    {
        if (!Multiple)
        {
            _files.Clear();
            _files.Add(e.File);
        }
        else
        {
            foreach (var file in e.GetMultipleFiles(100))
            {
                if (!_files.Any(f => f.Name == file.Name && f.Size == file.Size))
                    _files.Add(file);
            }
        }
        await OnChange.InvokeAsync(_files.AsReadOnly());
    }

    private async Task RemoveFile(IBrowserFile file)
    {
        _files.Remove(file);
        await OnChange.InvokeAsync(_files.AsReadOnly());
    }

    private async Task ClearAll()
    {
        _files.Clear();
        await OnChange.InvokeAsync(_files.AsReadOnly());
    }

    private async Task TriggerBrowse()
    {
        if (_module is null || Disabled || IsLoading) return;
        await _module.InvokeVoidAsync("triggerBrowse", _inputId);
    }

    private async Task TriggerUpload()
    {
        if (Disabled || IsLoading) return;
        await OnUpload.InvokeAsync(_files.AsReadOnly());
        if (!OnUpload.HasDelegate)
        {
            _files.Clear();
            await OnChange.InvokeAsync(_files.AsReadOnly());
        }
    }

    /// <summary>Called from JS to update the drag-over visual state.</summary>
    [JSInvokable]
    public void SetDragging(bool isDragging)
    {
        _isDragging = isDragging;
        StateHasChanged();
    }

    private static string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1048576) return $"{bytes / 1024.0:F1} KB";
        return $"{bytes / 1048576.0:F1} MB";
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
        {
            try
            {
                await _module.InvokeVoidAsync("dispose", _inputId);
                await _module.DisposeAsync();
            }
            catch (JSDisconnectedException) { }
        }
        _dotnetRef?.Dispose();
    }
}
