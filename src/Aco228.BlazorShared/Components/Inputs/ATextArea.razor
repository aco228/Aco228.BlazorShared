@using Microsoft.JSInterop
@implements IAsyncDisposable
@inject IJSRuntime JS

<AInputBase Title="@Title" Subtitle="@Subtitle" Disabled="@Disabled" IsLoading="@IsLoading" Width="@Width">
    <textarea class="a-textarea"
              disabled="@(Disabled || IsLoading)"
              placeholder="@Placeholder"
              @ref="_textareaEl"
              @oninput="OnInput">@Value</textarea>
</AInputBase>

@code {
    [Parameter] public string? Title { get; set; }
    [Parameter] public string? Subtitle { get; set; }
    [Parameter] public bool Disabled { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public int Width { get; set; }
    [Parameter] public string? Placeholder { get; set; }
    [Parameter] public string Value { get; set; } = string.Empty;
    [Parameter] public EventCallback<string> ValueChanged { get; set; }
    [Parameter] public EventCallback<string> OnChange { get; set; }
    [Parameter] public int MaxLines { get; set; } = 40;

    private ElementReference _textareaEl;
    private IJSObjectReference? _module;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _module = await JS.InvokeAsync<IJSObjectReference>(
                "import", "./_content/Aco228.BlazorShared/Components/Inputs/ATextArea.razor.js");
        }

        if (_module is not null)
            await _module.InvokeVoidAsync("autoResize", _textareaEl, MaxLines);
    }

    private async Task OnInput(ChangeEventArgs e)
    {
        Value = e.Value?.ToString() ?? string.Empty;
        if (_module is not null)
            await _module.InvokeVoidAsync("autoResize", _textareaEl, MaxLines);
        await ValueChanged.InvokeAsync(Value);
        await OnChange.InvokeAsync(Value);
    }

    public async ValueTask DisposeAsync()
    {
        if (_module is not null)
            await _module.DisposeAsync();
    }
}
