@using Aco228.BlazorShared.Code
@using Aco228.BlazorShared.Models

<div class="section">
    <div class="section-header">
        <div class="section-header-text">
            @if (Visibility != null)
            {
                <span class="section-opener" @onclick="OnVisibilityClicked"></span>
                
            }
            <span class="section-title">@Title</span>
            @if (!string.IsNullOrEmpty(Subtitle))
            {
                <span class="section-subtitle">@Subtitle</span>
            }
        </div>
        @if (Buttons is { Count: > 0 })
        {
            <div class="section-actions">
                @foreach (var btn in Buttons)
                {
                    <button class="section-btn" @onclick="btn.OnClick">@btn.Title</button>
                }
            </div>
        }
    </div>
    @if (Visibility == null || Visibility.IsVisible)
    {
        @if (CombinedIsLoading)
        {
            <div class="page-loading-overlay">
                <div class="page-loading-spinner"></div>
            </div>
        }
        @if (ChildContent != null)
        {
            <div class="section-body @(CombinedIsLoading ? "page-content--loading" : "")">
                @ChildContent
            </div>
        }
        else
        {
            <strong>Empty</strong>
        }
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="page-error">
                <span class="page-error-icon">!</span>
                <span>@ErrorMessage</span>
            </div>
        }
        else if (!string.IsNullOrEmpty(Component?.ErrorMessage))
        {
            <div class="page-error" @onclick="() => Component?.SetErrorMessage(string.Empty)">
                <span class="page-error-icon">!</span>
                <span>@Component.ErrorMessage</span>
            </div>
        }
    }
</div>

@code {
    [Parameter] public PageImplementation? Page { get; set; }
    [Parameter] public string Title { get; set; } = string.Empty;
    [Parameter] public string? Subtitle { get; set; }
    [Parameter] public List<SectionButton>? Buttons { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public VisibilityModel? Visibility { get; set; }
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public ComponentImplementation? Component { get; set; }

    private bool CombinedIsLoading => IsLoading || Page?.CombinedIsLoading == true || Component?.IsActionLoading == true;

    private void OnVisibilityClicked()
    {
        Visibility?.OnChange();
    }

}